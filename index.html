<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Link Description -->
    <meta name="description" content="A.R.C. Vault 254 Terminal - Vault-Tec Administrative Reclamation Command. Access Restricted.">
    <meta property="og:title" content="Vault 254 - A.R.C. Terminal">
    <meta property="og:description" content="Interactive Fallout-themed interface for Vault 254. Access restricted to Overseer clearance.">
    <meta property="og:type" content="website">
    
    <title>VAULT-TEC LINK v3.7.1 - VAULT 254</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- CRT EFFECTS & THEME --- */
        :root {
            --color-primary: #4ade80; /* Green 400 */
            --color-secondary: #064e3b; /* Green 900 */
            --color-alert: #ef4444; /* Red 500 */
            --color-warning: #eab308; /* Yellow 500 */
            --color-bg-dark: #050505;
        }

        @font-face {
            font-family: 'Share Tech Mono';
            src: url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        }

        body {
            background-color: #000;
            color: var(--color-primary);
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden; 
            cursor: default;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- ANIMATIONS --- */
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .animate-blink { animation: blink 1s step-end infinite; }

        @keyframes pulse-slow { 
            0%, 100% { opacity: 0.8; } 
            50% { opacity: 0.4; } 
        }
        .animate-pulse-slow { animation: pulse-slow 3s ease-in-out infinite; }
        
        @keyframes quick-flicker {
            0% { opacity: 1; }
            3% { opacity: 0.1; }
            6% { opacity: 1; }
            7% { opacity: 0.1; }
            9% { opacity: 1; }
            100% { opacity: 1; }
        }
        .animate-glitch { animation: quick-flicker 4s infinite linear; pointer-events: none; }

        @keyframes bar-dance {
            0% { height: 10%; }
            50% { height: 90%; }
            100% { height: 20%; }
        }

        @keyframes radar-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* --- CUSTOM CLASSES --- */
        .text-shadow-glow { 
            text-shadow: 0 0 2px rgba(74, 222, 128, 0.4), 0 0 8px rgba(74, 222, 128, 0.2); 
        }
        
        .font-handwriting { 
            font-family: 'Courier New', Courier, monospace; 
            letter-spacing: -0.5px; 
            font-style: italic;
            transform: rotate(-2deg);
        }

        /* Custom Scrollbar */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #15803d #0a1a0a;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0a1a0a; border-left: 1px solid #14532d; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #15803d; border: 1px solid #000; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #22c55e; }

        /* CRT Overlay Layers */
        .scanlines {
            background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.1) 50%), linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06));
            background-size: 100% 3px, 3px 100%;
            pointer-events: none;
            z-index: 50;
        }
        
        .crt-overlay {
            background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.4) 100%);
            pointer-events: none;
            z-index: 51;
        }
        
        /* Input styling for terminal */
        .terminal-input {
            background: transparent;
            border: none;
            color: var(--color-primary);
            font-family: inherit;
            outline: none;
            width: 100%;
            text-transform: uppercase;
        }
        
        /* Hidden input for login */
        .hidden-input {
            position: absolute;
            opacity: 0;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            cursor: default;
            caret-color: transparent; /* Hide default caret */
        }

        /* Cursor Block */
        .cursor-block {
            display: inline-block;
            width: 12px;
            height: 1.2em;
            background-color: var(--color-primary);
            vertical-align: bottom;
            animation: blink 1s step-end infinite;
            margin-right: 2px; /* spacing for reverse */
        }
        
        .grid-bg {
            background-image: linear-gradient(var(--color-secondary) 1px, transparent 1px),
            linear-gradient(90deg, var(--color-secondary) 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.2;
        }

        /* Specific solid background for modal to fix transparency */
        .modal-solid-bg {
            background-color: #000000; 
            background-image: radial-gradient(#111 1px, transparent 1px);
            background-size: 10px 10px;
        }
    </style>
</head>
<body>

    <!-- Root Container -->
    <div id="root" class="fixed inset-0 bg-black overflow-hidden selection:bg-green-500 selection:text-black touch-manipulation"></div>

<script>
    // --- LORE & DATA (VAULT 254 - A.R.C.) ---
    const CURRENT_DATE = "23.10.2275"; // 198 Years sealed

    const EMAILS = [
        {
            id: 'msg_001',
            from: 'Torres, M. (Reclamation)',
            to: 'Caldwell, V. (Overseer)',
            subject: 'Drone Recon Request #442',
            date: '22.10.2275',
            body: 'Vincent,\n\nI am formally requesting authorization for a drone launch again. The "Ghost Signal" from the Capital Wasteland proves there is organized life out there. We are sitting on 200 years of tech while eating algae paste.\n\nThe sensor readings are consistent. That isn\'t random static. It\'s a march. Someone is rebuilding. If we don\'t open the door soon, they will open it for us.\n\n- Michaela'
        },
        {
            id: 'msg_002',
            from: 'Ashford, L. (Preservation)',
            to: 'Council All',
            subject: 'Re: Drone Recon Request',
            date: '22.10.2275',
            body: 'Absolutely not.\n\nHave you forgotten the "Grey Drift"? Our genetic stability is hanging by a thread. Opening the blast door exposes us to pathogens we have no immunity to, let alone the radiation. The sensors indicate spikes in Sector 7. The surface is a graveyard.\n\nOur mandate is to survive until the Great Silence. It is decidedly NOT silent up there.\n\n- Lawrence'
        },
        {
            id: 'msg_003',
            from: 'Volkova, N. (Engineering)',
            to: 'Drake, R. (Security)',
            subject: 'Reactor Vibration ("The Heartbeat")',
            date: '21.10.2275',
            body: 'Roland, tell your guards to stop reporting the "humming" in the lower levels. I know about it. We call it "The Heartbeat."\n\nThe turbine stabilizers are worn. We can\'t manufacture new ones. We are cannibalizing the secondary backup generator to keep the primary running.\n\nUnless you have a spare GE-V7 Turbine in your armory, stop clogging my inbox.\n\n- Natasha'
        },
        {
            id: 'msg_004',
            from: 'Cross, D. (Education)',
            to: 'Caldwell, V. (Overseer)',
            subject: 'Curriculum Update: Pre-War History',
            date: '20.10.2275',
            body: 'Overseer,\n\nThe "Innovator" faction children are asking difficult questions during History class. Specifically about the Resource Wars.\n\nThey want to know why Vault-Tec didn\'t stop the bombs if they knew they were coming. The standard "Corporate Salvation" module isn\'t working on this generation. They are cynical. We might need to revise the G.O.A.T. questions to screen for this kind of dissent earlier.\n\n- Daniel'
        },
        {
            id: 'msg_005',
            from: 'Dr. Morrison (Medical)',
            to: 'Caldwell, V. (Overseer)',
            subject: 'Cryo Pod 089',
            date: '18.10.2275',
            body: 'We have a problem in the freezer.\n\nPod 089 (Executive V.P. S. Calvin). Vital signs are fluctuating. Neural activity suggests he isn\'t in deep sleep anymore. He might be dreaming. Or screaming. It\'s hard to tell with the synaptic decay.\n\nIf we don\'t thaw him soon, we lose him. But if we thaw him, we break the "All or Nothing" protocol. Your call.\n\n- Jim'
        }
    ];

    const FILE_SYSTEM = {
        root: { id: 'root', name: 'MAIN DRIVE', type: 'folder', children: ['mission', 'factions', 'military', 'engineering', 'medical', 'restricted'] },
        mission: { id: 'mission', name: 'MISSION PROFILE', type: 'folder', children: ['project_ark', 'langston_quote', 'timeline'] },
        project_ark: { id: 'project_ark', name: 'PROJECT_ARC_OVERVIEW.TXT', type: 'file', content: 'SUBJECT: A.R.C. (Vault 254)\nCLASSIFICATION: V-TEC EYES ONLY\n\nThe Administrative Reclamation Command is a CONTROL VAULT designed to preserve the corporate hierarchy of Vault-Tec.\n\nLOCATION: Appalachian Mountains, Sector 4\n\nPOPULATION:\n- 120 Executives (Cryo-Stasis)\n- 880 Staff Descendants (Active)\n\nMANDATE:\n1. SURVIVE the nuclear exchange.\n2. MAINTAIN the facility until surface viability.\n3. AWAKEN the Executives (Reclamation Day).\n4. RESTORE corporate governance to the United States.' },
        langston_quote: { id: 'langston_quote', name: 'QUOTE_LANGSTON.LOG', type: 'file', content: '"To Vault-Tec, innovating today, safeguarding tomorrow, and leading a better world after."\n\n- Frederick Langston, Board of Directors\n\n(This quote is mandatory memorization for all Grade 3 Students)' },
        timeline: { id: 'timeline', name: 'HISTORY_LOG.DAT', type: 'file', content: '[2073] Construction of Vault 254 begins.\n[2077.10.23] 09:13 AM: Detection of inbound ICBMs.\n[2077.10.23] 09:47 AM: Vault 254 Sealed.\n[2102] Reclamation Day cancelled by Overseer Caldwell I due to toxicity.\n[2180] "The Deep Tremor" damages Geothermal vents.\n[2275] PRESENT DAY. 198 Years Sealed.' },
        
        factions: { id: 'factions', name: 'INTERNAL POLITICS', type: 'folder', children: ['faction_summary', 'loyalist_manifesto', 'innovator_demands'] },
        faction_summary: { id: 'faction_summary', name: 'FACTION_INTEL.DOC', type: 'file', content: 'INTERNAL FACTION BREAKDOWN (2275)\n\n1. LOYALISTS (Overseer Caldwell)\n- Goal: Status Quo. Trust the Plan.\n\n2. RECLAMATIONISTS (Michaela Torres)\n- Goal: Open the door NOW. Aggressive expansion.\n\n3. PRESERVATIONISTS (Lawrence Ashford)\n- Goal: Permanent isolation. The surface is death.\n\n4. INNOVATORS (Natasha Volkova)\n- Goal: Adapt tech. Break protocols to fix things.\n\n5. EDUCATORS (Daniel Cross)\n- Goal: Reform education. Question pre-war doctrine.' },
        
        military: { id: 'military', name: 'SECURITY & DEFENSE', type: 'folder', children: ['roster', 'armory', 'threats'] },
        roster: { id: 'roster', name: 'FORCE_MANIFEST.DB', type: 'file', content: 'COMMANDER: Chief Roland Drake ("The Guards")\n\nACTIVE DUTY: 120 Personnel\n\nASSETS:\n- 100 Protectron Units (Security Config)\n- 100 Mr. Handy Units (Maintenance)\n\nNOTE: We cannot manufacture new robots. Every loss is permanent.' },
        armory: { id: 'armory', name: 'ARMORY_STATUS.TXT', type: 'file', content: 'STOCKPILE:\n- T-45 Power Armor: 20 Suits (Only 10 qualified operators)\n- R91 Assault Rifles: 200 Units\n- 10mm Pistols: 150 Units\n\nCRITICAL WEAKNESS:\n- NO Energy Weapons capability.\n- NO Heavy Weapons capability.\n- Ammo stocks for 5.56mm are depleting.' },
        threats: { id: 'threats', name: 'SURFACE_THREATS.LOG', type: 'file', content: 'SENSOR ANALYSIS:\n\nSEISMIC: Rhythmic marching detected. Mass > 2000kg. Possible Super Mutant Behemoth or Heavy Power Armor battalion.\n\nAUDIO: "Ghost Signal". American patriotic music detected on loop. Origin unknown.\n\nRADIATION: Wind shifts from D.C. Ruins periodically spike Rad levels to lethal.' },
        
        engineering: { id: 'engineering', name: 'ENGINEERING', type: 'folder', children: ['reactor', 'water_chip', 'maintenance'] },
        reactor: { id: 'reactor', name: 'REACTOR_DIAGNOSTICS.LOG', type: 'file', content: 'SYSTEM: General Atomics Nuclear Generator\nSTATUS: ONLINE (98.4% Efficiency)\nLIFESPAN: Est. 800 Years remaining.\n\nISSUE: Secondary Coolant Pump vibration. Replacement parts unavailable. Fabricating generic patches.' },
        water_chip: { id: 'water_chip', name: 'WATER_PURIFICATION.SYS', type: 'file', content: 'COMPONENT: Water Chip (Model 2077-B)\nSTATUS: FUNCTIONAL\n\nNOTE: This is our last chip. Do not touch it. Do not look at it wrong. If it breaks, we die.' },
        
        medical: { id: 'medical', name: 'MEDICAL', type: 'folder', children: ['patient_zero', 'supply_list'] },
        patient_zero: { id: 'patient_zero', name: 'GENETIC_DRIFT_STUDY.DOC', type: 'file', content: 'SUBJECT: The "Grey Drift"\n\nWe are seeing immune system depression in Generation 6 children. The genetic bottleneck is real. We need new DNA to prevent a cascade failure within 50 years.\n\nThis supports the Reclamationist argument, though I hate to admit it.\n- Dr. Morrison' },
        
        restricted: { id: 'restricted', name: 'RESTRICTED AREA', type: 'folder', locked: true, children: ['executive_list', 'wakeup_protocol'] },
        executive_list: { id: 'executive_list', name: 'BOARD_MEMBERS.ENC', type: 'file', content: '*** EYES ONLY ***\n\nCRYO-POD 001: Frederick Langston\nCRYO-POD 002: Leonard Vance (CEO)\nCRYO-POD 120: S. Calvin\n\nTOTAL: 120 Executives.\nSTATUS: Stable (mostly).' },
        wakeup_protocol: { id: 'wakeup_protocol', name: 'RECLAMATION_DAY.EXE', type: 'file', content: 'PROTOCOL 77-RECLAIM\n\n1. Unseal Blast Door.\n2. Deploy Security Perimeter.\n3. Initiate Thaw Cycle (12 Hours).\n\nWARNING: Authorization Code required. Only the Overseer can initiate.' }
    };

    // --- GLOBAL STATE ---
    window.state = {
        loggedIn: false,
        booted: false,
        loginInput: '',
        loginError: '',
        bootLog: [],
        activeApp: null, 
        showNote: false,
        terminal: {
            path: ['root'],
            viewingFile: null,
            unlocked: [],
            unlockTarget: null,
            unlockInput: '',
            cmdLog: ['Welcome to ROBCO Terminal v3.5', 'Type "help" for commands.'],
            cmdInput: ''
        },
        mail: {
            selectedEmailId: null,
        },
        map: {
            selectedRoom: null, 
        },
        status: {
            selectedSensor: null, 
        }
    };

    // --- STATE MANAGEMENT ---
    window.setState = (newState) => {
        let shouldRender = false;
        Object.keys(newState).forEach(key => {
            if (JSON.stringify(window.state[key]) !== JSON.stringify(newState[key])) {
                if (typeof newState[key] === 'object' && newState[key] !== null && !Array.isArray(newState[key]) && window.state[key]) {
                    window.state[key] = { ...window.state[key], ...newState[key] };
                } else {
                    window.state[key] = newState[key];
                }
                shouldRender = true;
            }
        });
        if (shouldRender) renderApp();
    };

    // --- CLOCK ---
    setInterval(() => {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const clockEl = document.getElementById('system-clock');
        if (clockEl) clockEl.innerText = timeString;
    }, 1000);

    // --- RENDERING SYSTEM ---
    const root = document.getElementById('root');

    function renderApp() {
        if (!document.getElementById('shell-container')) {
            root.innerHTML = `
                ${renderCRTOverlay()}
                <div id="shell-container" class="h-full w-full p-0 md:p-8 transition-opacity duration-1000">
                    <div class="h-full w-full border-0 md:border-[16px] border-[#1a1a1a] rounded-none md:rounded-3xl bg-[#0a0a0a] relative shadow-[0_0_0_2px_#333,0_0_50px_rgba(0,0,0,0.8)] overflow-hidden flex flex-col box-border">
                        <!-- Reflection -->
                        <div class="hidden md:block absolute top-0 right-0 w-1/3 h-1/3 bg-gradient-to-bl from-white/5 to-transparent rounded-tr-xl pointer-events-none z-40"></div>
                        <!-- Screen Content -->
                        <div id="screen-content" class="flex-1 overflow-hidden bg-black text-shadow-glow relative z-10 font-mono text-green-500"></div>
                    </div>
                </div>
                <div id="modal-layer"></div>
            `;
        }

        const screenContent = document.getElementById('screen-content');
        const modalLayer = document.getElementById('modal-layer');
        const { loggedIn, booted, activeApp } = window.state;

        // Render Logic
        if (!loggedIn) {
            screenContent.innerHTML = renderLoginScreen();
            modalLayer.innerHTML = '';
            document.getElementById('login-input')?.focus();
        } else if (!booted) {
             screenContent.innerHTML = renderBootSequence();
             modalLayer.innerHTML = '';
        } else {
            modalLayer.innerHTML = activeApp ? renderModalWindow() : '';
            if (!document.getElementById('desktop-interface')) {
                 screenContent.innerHTML = renderMainInterface();
            }
        }
        
        lucide.createIcons();
        
        // Auto-scroll terminal log
        const logEl = document.getElementById('terminal-log');
        if(logEl) logEl.scrollTop = logEl.scrollHeight;
    }

    function renderCRTOverlay() {
        return `
        <div class="pointer-events-none fixed inset-0 z-50 overflow-hidden">
            <div class="absolute inset-0 scanlines"></div>
            <div class="absolute inset-0 crt-overlay"></div>
        </div>`;
    }

    // --- LOGIN SCREEN ---
    function renderLoginScreen() {
        const { loginInput, loginError, showNote } = window.state;
        
        // Custom Retro Input Rendering
        const renderedPass = '•'.repeat(loginInput.length);
        
        return `
        <div class="h-full w-full flex flex-col items-center justify-center relative bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-green-900/20 via-black to-black">
            
            <!-- Vault-Tec Header -->
            <div class="mb-8 text-center animate-fade-in">
                <div class="text-4xl md:text-6xl font-bold tracking-tighter mb-2 text-green-500 text-shadow-glow">VAULT-TEC</div>
                <div class="text-xs md:text-sm tracking-[0.5em] text-green-700">ADMINISTRATIVE RECLAMATION COMMAND</div>
                <div class="text-xs text-green-800 mt-1">TERMINAL LINK V3.5</div>
            </div>

            <!-- Login Box -->
            <div class="w-full max-w-md p-6 border-2 border-green-800 bg-black/80 relative shadow-[0_0_30px_rgba(74,222,128,0.1)]">
                <div class="absolute -top-3 left-4 bg-black px-2 text-xs text-green-600 font-bold border-l border-r border-green-800">SECURE ACCESS</div>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-xs text-green-700 mb-1">USER ID</label>
                        <div class="w-full p-2 border border-green-600 bg-green-900/20 text-green-400 font-mono">OVERSEER_V.CALDWELL</div>
                    </div>
                    
                    <div>
                        <label class="block text-xs text-green-700 mb-1">PASSWORD</label>
                        <div class="relative w-full border border-green-600 h-10 bg-black flex items-center px-2 overflow-hidden">
                            <!-- Visual Representation -->
                            <div class="text-green-500 font-bold text-lg tracking-widest z-10 pointer-events-none h-full flex items-center">
                                <span class="cursor-block"></span><span>${renderedPass}</span>
                            </div>
                            
                            <!-- Hidden Actual Input -->
                            <input id="login-input" type="password" 
                                class="hidden-input"
                                value="${loginInput}"
                                oninput="window.setState({ loginInput: this.value, loginError: '' })"
                                onkeydown="if(event.key === 'Enter') attemptLogin()"
                                autofocus>
                        </div>
                    </div>

                    <button onclick="attemptLogin()" class="w-full py-3 bg-green-900/40 border border-green-600 hover:bg-green-500 hover:text-black transition-all font-bold tracking-widest text-sm uppercase">
                        Initialize Link
                    </button>
                    
                    <div class="h-4 text-center">
                        ${loginError ? `<span class="text-red-500 text-xs font-bold animate-glitch">ERROR: ${loginError}</span>` : ''}
                    </div>
                </div>
            </div>

            <!-- Sticky Note Hint -->
            <div onclick="window.setState({ showNote: !window.state.showNote })" 
                 class="absolute bottom-10 right-10 w-60 h-auto min-h-[160px] bg-yellow-100 rotate-2 shadow-lg p-6 cursor-pointer hover:scale-105 transition-transform origin-bottom-right z-20">
                <div class="font-handwriting text-black text-sm leading-tight opacity-90">
                    <span class="block border-b border-black/20 pb-1 mb-2 font-bold text-black/50">MEMO</span>
                    Vincent,<br><br>
                    System reset complete.<br>
                    Password is your last name backwards:<br><br>
                    <strong>LLEWDLAC</strong><br><br>
                    - Drake
                </div>
                 <div class="absolute top-0 right-0 p-1 opacity-20"><i data-lucide="pin" width="16" class="text-black"></i></div>
            </div>

            <div class="absolute bottom-4 text-[10px] text-green-900 font-mono text-center w-full">
                UNAUTHORIZED ACCESS IS A CLASS A FELONY PUNISHABLE BY IMMEDIATE TERMINATION
            </div>
        </div>`;
    }

    function attemptLogin() {
        const pass = window.state.loginInput.trim().toUpperCase();
        if (pass === 'LLEWDLAC' || pass === 'ADMIN') {
            window.setState({ loggedIn: true });
            initBootProcess();
        } else {
            window.setState({ loginError: 'INVALID CREDENTIALS', loginInput: '' });
        }
    }

    // --- BOOT SEQUENCE ---
    const BOOT_TEXT_FULL = [
        "VAULT-TEC BIOS v6.21",
        "COPYRIGHT 2077 ROBCO INDUSTRIES",
        "INITIALIZING HARDWARE...",
        "> CPU_MAIN (ZAX-PC) ... OK",
        "> MEMORY_BANK_0 ... OK",
        "> MEMORY_BANK_1 ... OK",
        "> CRYOGENIC CONTROLS ... LINKED",
        "> WATER CHIP ... DETECTED",
        "LOADING OS...",
        "MOUNTING DRIVE: A.R.C. ARCHIVE ... DONE",
        "CONNECTING TO NETWORK: LOCAL VAULT 254 ... DONE",
        " ",
        "WELCOME, OVERSEER CALDWELL.",
        "REMINDER: RECLAMATION DAY IS PENDING.",
        "STARTING DESKTOP ENVIRONMENT..."
    ];

    function initBootProcess() {
        if (window.bootInterval) clearInterval(window.bootInterval);
        let lineIndex = 0;
        window.bootInterval = setInterval(() => {
            if (lineIndex < BOOT_TEXT_FULL.length) {
                const line = BOOT_TEXT_FULL[lineIndex];
                window.state.bootLog.push(line);
                renderApp(); 
                lineIndex++;
            } else {
                clearInterval(window.bootInterval);
                setTimeout(() => window.setState({ booted: true }), 800);
            }
        }, 150); 
    }

    function renderBootSequence() {
        return `
            <div class="h-full w-full p-8 flex flex-col justify-end bg-black">
                <div class="flex flex-col justify-end items-start overflow-hidden">
                    ${window.state.bootLog.map(line => `<div class="mb-1 text-sm md:text-base ${line.includes('WARNING') ? 'text-yellow-500' : 'text-green-500'}">${line}</div>`).join('')}
                    <div class="animate-blink bg-green-500 h-4 w-3 mt-1 inline-block"></div>
                </div>
            </div>
        `;
    }

    // --- DESKTOP ---
    function renderMainInterface() {
        const timeNow = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });

        return `
        <div id="desktop-interface" class="h-full flex flex-col relative animate-fade-in bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')]">
            <!-- Background Logo -->
            <div class="absolute inset-0 flex items-center justify-center opacity-5 pointer-events-none">
                <div class="w-64 h-64 border-8 border-green-500 rounded-full flex items-center justify-center">
                    <div class="text-9xl font-bold text-green-500 tracking-tighter">V</div>
                </div>
            </div>

            <!-- Top Bar -->
            <div class="h-8 md:h-10 bg-green-900/20 border-b border-green-800 flex items-center px-4 justify-between shrink-0 z-20">
                <div class="text-xs font-bold text-green-600">VAULT 254 // OVERSEER TERMINAL</div>
                <div class="text-xs font-mono text-green-600 flex gap-4">
                    <span>STATUS: <span class="text-green-400">SEALED</span></span>
                    <span>NET: <span class="text-green-400">LOCAL</span></span>
                </div>
            </div>

            <!-- Icons Area -->
            <div class="flex-1 p-4 md:p-8 flex content-start flex-wrap gap-4 md:gap-8 relative z-10 overflow-y-auto custom-scrollbar">
                ${renderDesktopIcon('ARCHIVES', 'terminal', "window.setState({ activeApp: 'terminal' })")}
                ${renderDesktopIcon('MESSAGES', 'mail', "window.setState({ activeApp: 'mail' })")}
                ${renderDesktopIcon('FACILITY', 'map', "window.setState({ activeApp: 'map' })")}
                ${renderDesktopIcon('SENSORS', 'activity', "window.setState({ activeApp: 'status' })")}
            </div>

            <!-- Bottom Bar -->
            <div class="h-10 md:h-12 border-t-2 border-green-700 bg-green-900/30 flex items-center px-4 justify-between z-20 shrink-0 backdrop-blur-sm">
                <div class="flex items-center gap-4">
                    <button class="bg-green-700 text-black px-4 py-1 font-bold text-xs hover:bg-green-500 hover:text-white transition-colors uppercase">
                        SYSTEM MENU
                    </button>
                    <div class="h-6 w-px bg-green-800"></div>
                    <div class="text-[10px] text-green-500 animate-glitch">
                        <span class="mr-2">⚠ ALERT:</span> SURFACE SEISMIC ACTIVITY DETECTED
                    </div>
                </div>
                <div class="text-xs text-green-400 font-mono font-bold flex items-center gap-4">
                    <span id="system-clock">${timeNow}</span>
                    <span>${CURRENT_DATE}</span>
                </div>
            </div>
        </div>`;
    }

    function renderDesktopIcon(label, iconName, onClickAction) {
        return `
        <button onclick="${onClickAction}" class="flex flex-col items-center justify-center gap-2 p-2 rounded hover:bg-green-900/20 group w-24 md:w-32 transition-all duration-200">
            <div class="text-green-500 group-hover:text-green-300 group-hover:-translate-y-1 transition-transform bg-black/40 p-3 md:p-4 rounded-xl border border-transparent group-hover:border-green-500/50 shadow-lg">
                <i data-lucide="${iconName}" width="32" height="32" class="w-8 h-8 md:w-10 md:h-10 stroke-[1.5]"></i>
            </div>
            <span class="text-[10px] md:text-xs font-bold text-green-600 group-hover:text-green-400 bg-black/60 px-2 py-0.5 rounded text-center border border-transparent group-hover:border-green-900 shadow-sm uppercase tracking-wide w-full truncate">
                ${label}
            </span>
        </button>`;
    }

    // --- MODAL WINDOW ---
    function renderModalWindow() {
        const { activeApp } = window.state;
        let content = '', title = '', icon = '', closeAction = "window.setState({ activeApp: null })";

        switch (activeApp) {
            case 'terminal': 
                content = renderTerminalApp(); 
                title = 'ROBCO FILE MANAGER';
                icon = 'terminal';
                closeAction = "window.setState({ activeApp: null, terminal: { ...window.state.terminal, unlockTarget: null, viewingFile: null } })";
                break;
            case 'mail': 
                content = renderMailApp(); 
                title = 'VAULT-MAIL v1.2';
                icon = 'mail';
                closeAction = "window.setState({ activeApp: null, mail: { selectedEmailId: null } })";
                break;
            case 'map': 
                content = renderMapApp(); 
                title = 'VAULT 254 ARCHITECT';
                icon = 'map';
                closeAction = "window.setState({ activeApp: null, map: { selectedRoom: null } })";
                break;
            case 'status': 
                content = renderStatusApp(); 
                title = 'OVERSEER DASHBOARD';
                icon = 'activity';
                closeAction = "window.setState({ activeApp: null, status: { selectedSensor: null } })";
                break;
        }

        return `
        <div class="absolute inset-0 md:inset-6 z-40 bg-black/60 backdrop-blur-[2px] md:backdrop-blur-none animate-fade-in flex items-center justify-center p-2 md:p-0">
            <div class="flex flex-col w-full h-full md:max-w-5xl md:max-h-[90%] bg-black border-2 border-green-600 shadow-[0_0_40px_rgba(0,255,0,0.15)] relative">
                <!-- Modal Header -->
                <div class="bg-green-900/30 p-2 md:p-3 border-b border-green-700 flex justify-between items-center shrink-0">
                    <div class="flex items-center gap-2 text-green-400 font-bold text-sm tracking-wider">
                        <i data-lucide="${icon}" width="16"></i>
                        <span>${title}</span>
                    </div>
                    <button onclick="${closeAction}" class="text-green-600 hover:text-green-300 hover:bg-green-900/50 p-1 rounded transition-colors">
                        <i data-lucide="x" width="20"></i>
                    </button>
                </div>
                <!-- Modal Content -->
                <div class="flex-1 overflow-hidden relative bg-black/90">
                    ${content}
                </div>
            </div>
        </div>`;
    }

    // --- TERMINAL APP ---
    function renderTerminalApp() {
        const { path, viewingFile, unlocked, unlockTarget, unlockInput, cmdLog, cmdInput } = window.state.terminal;
        const currentFolder = FILE_SYSTEM[path[path.length - 1]];

        // Password Unlock Screen
        if (unlockTarget) {
            return `
            <div class="flex flex-col items-center justify-center h-full p-8 text-center bg-black">
                <div class="border border-red-900 bg-red-900/10 p-8 max-w-sm w-full">
                    <i data-lucide="lock" width="48" class="text-red-500 mb-4 mx-auto animate-pulse-slow"></i>
                    <h3 class="text-red-500 font-bold text-xl mb-4 tracking-widest">RESTRICTED AREA</h3>
                    <div class="text-xs text-red-700 mb-6">SECURITY CLEARANCE: OMEGA REQ.</div>
                    
                    <input id="term-input" type="password" value="${unlockInput}" 
                        oninput="window.state.terminal.unlockInput = this.value" 
                        class="bg-black border border-red-500 text-red-500 p-2 text-center focus:outline-none uppercase text-lg w-full mb-4" 
                        placeholder="PASSWORD" autofocus>
                    
                    <div class="flex gap-2">
                        <button onclick="window.setState({ terminal: { unlockTarget: null, unlockInput: '' } })" class="flex-1 border border-red-900 text-red-700 hover:text-red-500 py-2">CANCEL</button>
                        <button onclick="attemptUnlock()" class="flex-1 bg-red-900/30 border border-red-500 text-red-500 hover:bg-red-500 hover:text-black py-2 font-bold">ACCESS</button>
                    </div>
                    <div id="unlock-msg" class="mt-4 h-4 text-red-500 font-bold text-xs"></div>
                </div>
            </div>`;
        }

        // File Viewer
        if (viewingFile) {
            const file = FILE_SYSTEM[viewingFile];
            return `
            <div class="flex flex-col h-full p-4 bg-[#050505]">
                <div class="flex justify-between items-center mb-4 border-b border-green-800 pb-2">
                    <div class="flex flex-col">
                        <span class="text-green-400 font-bold text-lg uppercase">${file.name}</span>
                        <span class="text-[10px] text-green-700">AUTHOR: SYSTEM | SIZE: 4KB</span>
                    </div>
                    <button onclick="window.setState({ terminal: { viewingFile: null } })" class="text-xs border border-green-600 text-green-600 px-3 py-1 hover:bg-green-500 hover:text-black transition-colors">CLOSE</button>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar p-2 border border-green-900/30 bg-green-900/5">
                    <pre class="whitespace-pre-wrap font-mono text-green-400 text-sm leading-relaxed">${file.content}</pre>
                </div>
            </div>`;
        }

        // File Browser
        const pathDisplay = path.map(id => `/${FILE_SYSTEM[id].name}`).join('');
        const children = currentFolder.children.map(childId => {
            const item = FILE_SYSTEM[childId];
            const isLocked = item.locked && !unlocked.includes(childId);
            const icon = item.type === 'folder' ? (isLocked ? 'lock' : 'folder') : 'file-text';
            const color = isLocked ? 'text-red-500' : (item.type === 'folder' ? 'text-yellow-500' : 'text-green-400');
            
            return `
            <button onclick="handleTerminalClick('${childId}')" class="flex items-center gap-3 p-3 border border-transparent hover:border-green-800 hover:bg-green-900/10 transition-all text-left group w-full">
                <i data-lucide="${icon}" width="18" class="${color} group-hover:scale-110 transition-transform"></i>
                <div class="flex-1 min-w-0">
                    <div class="font-bold text-sm truncate ${isLocked ? 'text-red-400' : 'text-green-300'}">${item.name}</div>
                    <div class="text-[10px] text-green-800 uppercase">${item.type}</div>
                </div>
                ${isLocked ? '<i data-lucide="shield-alert" width="14" class="text-red-500"></i>' : ''}
            </button>`;
        }).join('');

        return `
        <div class="flex flex-col h-full p-4">
            <!-- Path Bar -->
            <div class="flex items-center gap-2 mb-4 text-xs text-green-500 border-b border-green-800 pb-2 overflow-x-auto shrink-0 font-mono">
                <span class="text-green-700">ROOT:</span> ${pathDisplay}
                ${path.length > 1 ? `<button onclick="window.setState({ terminal: { path: window.state.terminal.path.slice(0, -1) } })" class="ml-auto hover:text-white px-2 border border-green-800">BACK</button>` : ''}
            </div>

            <!-- Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 overflow-y-auto custom-scrollbar flex-1 content-start">
                ${children}
            </div>
            
            <!-- Command Line -->
            <div class="mt-4 pt-2 border-t border-green-800 h-1/3 flex flex-col bg-black">
                <div class="text-[10px] text-green-700 mb-1 flex justify-between">
                    <span>TERMINAL EMULATOR</span>
                    <span>USER: OVERSEER</span>
                </div>
                <div id="terminal-log" class="flex-1 overflow-y-auto custom-scrollbar text-xs font-mono text-green-500/80 mb-2 p-1 font-bold">
                    ${cmdLog.map(line => `<div>${line}</div>`).join('')}
                </div>
                <div class="flex items-center gap-2 text-green-500 bg-green-900/10 p-1">
                    <span class="font-bold">&gt;</span>
                    <input id="cmd-input" type="text" class="terminal-input font-bold" value="${cmdInput}" 
                        oninput="window.state.terminal.cmdInput = this.value" 
                        onkeydown="if(event.key === 'Enter') handleTerminalCommand(this.value)"
                        autocomplete="off" spellcheck="false" autofocus>
                </div>
            </div>
        </div>`;
    }

    // --- TERMINAL LOGIC ---
    window.handleTerminalCommand = (cmd) => {
        const cleanCmd = cmd.trim().toLowerCase();
        let response = [];
        const { terminal } = window.state;
        
        if (!cleanCmd) return;

        switch(cleanCmd) {
            case 'help':
                response = ["COMMANDS: LS, CD [DIR], OPEN [FILE], CLEAR, DATE, STATUS, WHOAMI, UNLOCK, RECLAIM"];
                break;
            case 'ls':
                const currentFolder = FILE_SYSTEM[terminal.path[terminal.path.length - 1]];
                response = [currentFolder.children.map(id => FILE_SYSTEM[id].name).join('  ')];
                break;
            case 'clear':
                window.setState({ terminal: { cmdLog: [], cmdInput: '' } });
                return;
            case 'reclaim':
                response = ["INITIATING RECLAMATION DAY PROTOCOL...", "ERROR: MASTER KEYCARD REQUIRED.", "ERROR: SURFACE VIABILITY < 10%"];
                break;
            case 'unlock':
                response = ["USAGE: SELECT LOCKED FOLDER IN GUI TO ENTER PASSWORD."];
                break;
            case 'status':
                response = ["VAULT 254: SEALED", "POPULATION: 1000", "POWER: 98%", "WATER: STABLE"];
                break;
            default:
                response = [`ERROR: COMMAND '${cleanCmd}' UNKNOWN.`];
        }

        const newLog = [...terminal.cmdLog, `> ${cmd}`, ...response];
        if (newLog.length > 50) newLog.splice(0, newLog.length - 50);

        window.setState({ terminal: { cmdLog: newLog, cmdInput: '' } });
        
        setTimeout(() => {
            const inputEl = document.getElementById('cmd-input');
            if(inputEl) inputEl.focus();
        }, 50);
    };

    window.handleTerminalClick = (id) => {
        const item = FILE_SYSTEM[id];
        const { unlocked, path } = window.state.terminal;
        if (item.type === 'file') {
            window.setState({ terminal: { viewingFile: id } });
        } else {
            if (item.locked && !unlocked.includes(id)) {
                window.setState({ terminal: { unlockTarget: id, unlockInput: '' } });
            } else {
                window.setState({ terminal: { path: [...path, id] } });
            }
        }
    };

    window.attemptUnlock = () => {
        const { unlockInput, unlockTarget, unlocked, path } = window.state.terminal;
        if (unlockInput.trim().toUpperCase() === 'ADMIN_KEY' || unlockInput.trim().toUpperCase() === 'CALDWELL') {
            window.setState({ 
                terminal: { 
                    unlocked: [...unlocked, unlockTarget], 
                    path: [...path, unlockTarget], 
                    unlockTarget: null, 
                    unlockInput: '' 
                } 
            });
        } else {
            const msg = document.getElementById('unlock-msg');
            if (msg) {
                msg.textContent = 'ACCESS DENIED: INCORRECT CREDENTIALS';
                setTimeout(() => msg.textContent = '', 2000);
            }
            window.state.terminal.unlockInput = '';
            document.getElementById('term-input').value = '';
        }
    };

    // --- MAIL APP ---
    function renderMailApp() {
        const { selectedEmailId } = window.state.mail;
        const selected = EMAILS.find(e => e.id === selectedEmailId);

        const listHtml = EMAILS.map(email => `
            <button onclick="window.setState({ mail: { selectedEmailId: '${email.id}' } })" 
                class="w-full text-left p-3 border-b border-green-900 hover:bg-green-900/20 transition-colors group ${selectedEmailId === email.id ? 'bg-green-900/40 border-l-2 border-l-green-400' : ''}">
                <div class="flex justify-between items-start mb-1">
                    <div class="font-bold text-green-300 text-xs w-2/3 truncate ${selectedEmailId === email.id ? 'text-green-100' : ''}">${email.from}</div>
                    <div class="text-[10px] text-green-700">${email.date}</div>
                </div>
                <div class="text-xs text-green-600 truncate group-hover:text-green-400">${email.subject}</div>
            </button>
        `).join('');

        const detailHtml = selected ? `
            <div class="flex flex-col h-full animate-fade-in">
                <!-- Mobile Back Button -->
                <div class="md:hidden mb-2">
                    <button onclick="window.setState({ mail: { selectedEmailId: null } })" class="text-xs flex items-center gap-1 text-green-500 border border-green-800 px-2 py-1">
                        <i data-lucide="arrow-left" width="12"></i> INBOX
                    </button>
                </div>
                
                <!-- Email Header -->
                <div class="bg-green-900/10 border border-green-800 p-4 mb-4">
                    <div class="grid grid-cols-[60px_1fr] gap-1 text-xs">
                        <span class="text-green-700">FROM:</span> <span class="text-green-300 font-bold">${selected.from}</span>
                        <span class="text-green-700">TO:</span> <span class="text-green-300">${selected.to}</span>
                        <span class="text-green-700">DATE:</span> <span class="text-green-300">${selected.date}</span>
                    </div>
                    <div class="border-t border-green-900 mt-2 pt-2 text-sm md:text-base font-bold text-green-100">
                        ${selected.subject}
                    </div>
                </div>

                <!-- Body -->
                <div class="flex-1 overflow-y-auto custom-scrollbar p-2">
                    <div class="text-green-400 whitespace-pre-wrap font-mono text-sm leading-relaxed max-w-2xl">${selected.body}</div>
                </div>
                
                <!-- Footer -->
                <div class="mt-4 pt-2 border-t border-green-900 text-[10px] text-green-800 flex justify-between">
                    <span>SECURE TRANSMISSION</span>
                    <span>VAULT-TEC INTRANET</span>
                </div>
            </div>
        ` : `<div class="h-full flex flex-col items-center justify-center text-green-800">
                <i data-lucide="mail" width="64" class="mb-4 opacity-20"></i>
                <div class="text-sm tracking-widest">SELECT MESSAGE</div>
             </div>`;

        return `
        <div class="flex h-full">
            <div class="w-full md:w-1/3 border-r border-green-800 overflow-y-auto custom-scrollbar ${selectedEmailId ? 'hidden md:block' : 'block'}">
                ${listHtml}
            </div>
            <div class="flex-1 p-4 bg-black overflow-hidden ${!selectedEmailId ? 'hidden md:block' : 'block'}">
                ${detailHtml}
            </div>
        </div>`;
    }

    // --- MAP APP ---
    function renderMapApp() {
        const { selectedRoom } = window.state.map;
        
        let overlay = '';
        if (selectedRoom) {
            // Detailed Schematic View (UPDATED for Opacity and Detail)
            overlay = `
            <div class="absolute inset-0 z-30 flex flex-col p-4 animate-fade-in modal-solid-bg">
                <div class="flex justify-between items-center mb-4 border-b-2 border-green-500 pb-2 bg-black/50">
                    <div class="flex items-center gap-3">
                        <div class="bg-green-500 text-black font-bold px-2 py-1 text-xs uppercase">ARCHITECT VIEW</div>
                        <h3 class="font-bold text-green-400 text-xl tracking-wider uppercase">${selectedRoom.name}</h3>
                    </div>
                    <button onclick="window.setState({ map: { selectedRoom: null } })" class="hover:bg-green-900/50 p-1 rounded transition-colors border border-transparent hover:border-green-500"><i data-lucide="x" width="24" class="text-green-500"></i></button>
                </div>

                <div class="flex-1 overflow-y-auto grid grid-cols-1 md:grid-cols-3 gap-6 p-2">
                    
                    <!-- Left Column: Schematic Visual -->
                    <div class="col-span-1 border-2 border-green-900/50 bg-black relative p-4 flex flex-col items-center justify-center min-h-[200px]">
                        <div class="absolute top-2 left-2 text-[10px] text-green-700">SCHEMATIC_RENDER_V2</div>
                        <!-- CSS Wireframe Placeholder -->
                        <div class="w-32 h-32 border-2 border-green-500/30 rotate-45 flex items-center justify-center relative">
                             <div class="absolute w-full h-[1px] bg-green-900 top-1/2 -translate-y-1/2"></div>
                             <div class="absolute h-full w-[1px] bg-green-900 left-1/2 -translate-x-1/2"></div>
                             <div class="w-16 h-16 border border-green-500/50"></div>
                             ${selectedRoom.alert ? '<div class="absolute inset-0 bg-red-500/10 animate-pulse"></div>' : ''}
                        </div>
                        <div class="mt-8 w-full">
                            <div class="flex justify-between text-[10px] text-green-600 mb-1">
                                <span>INTEGRITY</span>
                                <span>${selectedRoom.status === 'OK' ? '100%' : '84%'}</span>
                            </div>
                            <div class="h-1 bg-green-900 w-full"><div class="h-full ${selectedRoom.status === 'OK' ? 'bg-green-500' : 'bg-red-500'} w-[${selectedRoom.status === 'OK' ? '100%' : '84%'}]"></div></div>
                        </div>
                        <div class="mt-2 w-full">
                            <div class="flex justify-between text-[10px] text-green-600 mb-1">
                                <span>POWER DRAW</span>
                                <span>${Math.floor(Math.random() * 500) + 120} kWh</span>
                            </div>
                            <div class="h-1 bg-green-900 w-full"><div class="h-full bg-yellow-500 w-[45%]"></div></div>
                        </div>
                    </div>

                    <!-- Middle/Right Column: Data -->
                    <div class="col-span-1 md:col-span-2 flex flex-col gap-4">
                        <!-- Top Stats Box -->
                         <div class="grid grid-cols-2 gap-4">
                            <div class="border border-green-800 bg-green-900/10 p-3">
                                <div class="text-green-600 text-[9px] font-bold uppercase mb-1">OPERATIONAL STATUS</div>
                                <div class="text-xl font-mono ${selectedRoom.status === 'OK' ? 'text-green-400' : (selectedRoom.status === 'CRITICAL' || selectedRoom.status === 'SEALED' ? 'text-red-500' : 'text-yellow-500')}">
                                    ${selectedRoom.status}
                                </div>
                            </div>
                            <div class="border border-green-800 bg-green-900/10 p-3">
                                <div class="text-green-600 text-[9px] font-bold uppercase mb-1">PERSONNEL COUNT</div>
                                <div class="text-xl font-mono text-green-400">
                                    ${selectedRoom.personnel || 'N/A'}
                                </div>
                            </div>
                        </div>

                        <!-- Department Info -->
                        <div class="border-l-2 border-green-600 pl-4 py-2 bg-green-900/5">
                             <div class="text-green-600 text-[9px] font-bold uppercase">DEPARTMENT HEAD</div>
                             <div class="text-green-300 font-bold text-lg">${selectedRoom.head}</div>
                             <div class="text-green-700 text-xs mt-1 uppercase tracking-wider">[ ${selectedRoom.faction} FACTION ]</div>
                        </div>

                        <!-- Main Description -->
                        <div class="flex-1">
                            <div class="text-green-600 text-[10px] font-bold mb-2 border-b border-green-900 pb-1">SYSTEM LOGS & DESCRIPTION</div>
                            <div class="font-mono text-sm text-green-400 leading-relaxed whitespace-pre-wrap">${selectedRoom.desc}</div>
                        </div>
                        
                        ${selectedRoom.alert ? `
                        <div class="bg-red-900/20 border-l-4 border-red-500 p-3 mt-2">
                            <div class="text-red-500 text-[10px] font-bold flex items-center gap-2">
                                <i data-lucide="alert-triangle" width="12"></i> ACTIVE ALERT
                            </div>
                            <div class="text-red-400 text-xs mt-1 animate-glitch">${selectedRoom.alert}</div>
                        </div>` : ''}

                        <div class="mt-auto pt-4 flex justify-between items-end border-t border-green-900">
                            <div class="text-[10px] text-green-800 font-mono">
                                LAST MAINTENANCE: ${CURRENT_DATE}<br>
                                TECH ID: #44-291
                            </div>
                            <div class="text-xs border border-green-700 px-2 py-1 text-green-600">
                                ACCESS LEVEL: 3
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        const RoomBtn = (name, status, head, faction, desc, alert = null, cols = 1, personnel = '0') => {
            const safeName = name.replace(/'/g, "\\'").replace(/"/g, "&quot;");
            const safeHead = head.replace(/'/g, "\\'").replace(/"/g, "&quot;");
            const safeFaction = faction.replace(/'/g, "\\'").replace(/"/g, "&quot;");
            const safeDesc = desc.replace(/'/g, "\\'").replace(/"/g, "&quot;").replace(/\n/g, "\\n");
            const safeAlert = alert ? alert.replace(/'/g, "\\'").replace(/"/g, "&quot;") : '';

            let statusColor = 'text-green-800';
            let borderColor = 'border-green-800';
            if (status !== 'OK') {
                statusColor = status === 'SEALED' || status === 'CRITICAL' ? 'text-red-500' : 'text-yellow-500';
                borderColor = status === 'SEALED' || status === 'CRITICAL' ? 'border-red-900' : 'border-yellow-900';
            }

            return `
            <button onclick="window.setState({ map: { selectedRoom: { name: '${safeName}', status: '${status}', head: '${safeHead}', faction: '${safeFaction}', desc: '${safeDesc}', alert: '${safeAlert}', personnel: '${personnel}' } } })" 
                class="border ${borderColor} bg-green-900/5 hover:bg-green-500/10 p-3 text-left relative group min-h-[80px] col-span-${cols} transition-all flex flex-col justify-between">
                
                <div class="flex justify-between items-start w-full">
                    <div class="text-[10px] font-bold text-green-500 group-hover:text-green-300 uppercase">${name}</div>
                    <i data-lucide="maximize-2" width="10" class="text-green-700 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                </div>
                
                <div>
                    <div class="text-[9px] text-green-700 uppercase mb-1 truncate">${head}</div>
                    <div class="text-[9px] ${statusColor} font-bold animate-pulse">${status}</div>
                </div>
                
                <!-- Decorative Corner -->
                <div class="absolute bottom-0 right-0 w-2 h-2 border-b border-r border-green-600 opacity-50"></div>
            </button>`;
        };

        return `
        <div class="h-full flex flex-col relative overflow-hidden">
            ${overlay}
            <div class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-8 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
                <div class="max-w-4xl mx-auto space-y-12">
                    
                    <!-- L1 -->
                    <div class="relative">
                        <div class="absolute -left-6 top-0 bottom-0 border-l-2 border-dashed border-green-900"></div>
                        <h3 class="text-xs text-green-500 font-bold border-b border-green-900 mb-4 flex justify-between">
                            <span>LEVEL 1: ADMINISTRATION</span>
                            <span class="text-green-800">-50 METERS</span>
                        </h3>
                        <div class="grid grid-cols-4 gap-3">
                            ${RoomBtn('VAULT DOOR', 'SEALED', 'Overseer Eyes Only', 'Loyalists', 'The Great Seal (Model 77-A). Main hydraulic mechanisms verified intact. \\n\\nExternal sensors indicate lethal radiation levels in the immediate vestibule area (Zone 0). \\n\\nDefense Protocols: Automated turrets active. Camouflage netting requires replacement.', 'DOOR SEALED FOR 198 YEARS', 2, '0 (Auto)')}
                            ${RoomBtn('SECURITY ARMORY', 'OK', 'Chief Roland Drake', 'The Guards', 'Inventory Audit: \\n- 20 T-45d Power Armor Suits (10 Operational, 10 for parts)\\n- 200 R91 Assault Rifles\\n- 150 10mm Pistols\\n- 100 Security Batons\\n\\nCRITICAL: No energy weapon capability. Ballistic ammo conservation is mandatory.', null, 1, '12')}
                            ${RoomBtn('OVERSEER OFFICE', 'RESTRICTED', 'Vincent Caldwell', 'Loyalists', 'Executive command center. Direct uplink to central mainframe. Access to Reclamation Day protocols. Contains "The Black Book" (Vault-Tec Executive Summary).', 'BIOMETRIC LOCK ENGAGED', 1, '3')}
                        </div>
                    </div>

                    <!-- L2 -->
                    <div class="relative">
                        <div class="absolute -left-6 top-0 bottom-0 border-l-2 border-dashed border-green-900"></div>
                        <h3 class="text-xs text-green-500 font-bold border-b border-green-900 mb-4 flex justify-between">
                            <span>LEVEL 2: HABITATION</span>
                            <span class="text-green-800">-100 METERS</span>
                        </h3>
                        <div class="grid grid-cols-4 gap-3">
                            ${RoomBtn('ATRIUM', 'OK', 'Public Area', 'Neutral', 'Central gathering hub (Capacity: 500). LED sky-ceiling currently simulating "Overcast Afternoon" to reduce power consumption. Community notice board full of "Educator" flyers.', null, 4, '142')}
                            ${RoomBtn('EDUCATION', 'BUSY', 'Daniel Cross', 'Educators', 'Classrooms 1-4. Current Curriculum: "The Resource Wars: Why We Failed." \\n\\nStudents are undergoing G.O.A.T. prep. Head Instructor Cross has requested revised history holotapes regarding the Enclave.', 'REVISIONIST HISTORY DETECTED', 1, '45')}
                            ${RoomBtn('CAFETERIA', 'OK', 'Chef Handy Unit', 'Neutral', 'Serving: Algae Paste (Day 442). Coffee rations exhausted in 2274. \\n\\nMr. Handy unit "Chef Pierre" is requesting oil bath.', null, 1, '8')}
                            ${RoomBtn('QUARTERS A', 'OK', 'Housing Manager', 'Neutral', 'Staff housing block. Capacity 100%. Air filtration requires filter change in Block C.', null, 1, '320')}
                            ${RoomBtn('CLINIC', 'BUSY', 'Dr. James Morrison', 'Loyalists', 'Patient Load High. Tracking "Grey Drift" genetic anomalies in Generation 6 children. \\n\\nStimpak supply synthesis is stable. RadAway stocks: High. \\nEquipment: 4 Auto-Docs (3 Operational).', 'GENETIC DRIFT WARNING', 1, '18')}
                        </div>
                    </div>

                    <!-- L3 -->
                    <div class="relative">
                        <div class="absolute -left-6 top-0 bottom-0 border-l-2 border-dashed border-green-900"></div>
                        <h3 class="text-xs text-green-500 font-bold border-b border-green-900 mb-4 flex justify-between">
                            <span>LEVEL 3: ENGINEERING</span>
                            <span class="text-green-800">-200 METERS</span>
                        </h3>
                        <div class="grid grid-cols-4 gap-3">
                            ${RoomBtn('REACTOR', 'WARNING', 'Natasha Volkova', 'Innovators', 'General Atomics V-Series Nuclear Generator. Output 98.4%. Est. Fuel Lifespan: 800 Years. \\n\\nISSUE: Secondary Coolant Pump vibration ("The Heartbeat") is worsening. Volkova has requested permission to scavenge parts from Level 4.', 'VIBRATION DETECTED', 1, '15')}
                            ${RoomBtn('HYDROPONICS', 'OK', 'Lawrence Ashford', 'Preservationists', 'Three-level hydroponic bays. LED growth lights at 85% intensity. \\n\\nYield is nominal. Ashford reports slight mold growth in Sector 3 due to humidity controls. Producing: Tatoes, Mutfruit, Carrots, Medicinal Herbs.', null, 1, '60')}
                            ${RoomBtn('WATER PURIFICATION', 'CRITICAL', 'Auto-Sys', 'Neutral', 'Water Chip Model 2077-B functioning within parameters. Source: Mountain spring aquifer. \\n\\nWARNING: This is the LAST functional chip. No backups available. Failure results in total colony dehydration in 4 days.', 'SINGLE POINT OF FAILURE', 1, '2')}
                            ${RoomBtn('WORKSHOP', 'OK', 'Eng. Team', 'Innovators', 'Fabricating 10mm rounds and basic tools. \\n\\nT-45d repair bay active. Robot repair station offline due to lack of fusion pulse regulators. Cannot manufacture new robots.', null, 1, '22')}
                        </div>
                    </div>

                    <!-- L4 -->
                    <div class="relative">
                        <div class="absolute -left-6 top-0 bottom-0 border-l-2 border-dashed border-red-900/50"></div>
                        <h3 class="text-xs text-red-500 font-bold border-b border-red-900 mb-4 flex justify-between">
                            <span>LEVEL 4: RESTRICTED</span>
                            <span class="text-red-800">-400 METERS</span>
                        </h3>
                        <div class="grid grid-cols-4 gap-3 p-3 border border-red-900/30 bg-red-900/5">
                            ${RoomBtn('CRYO CONTROL', 'OK', 'Dr. Morrison', 'Loyalists', 'Monitoring station for 120 Executive Pods. Liquid Nitrogen levels holding. Backup generators primed.', null, 2, '5')}
                            ${RoomBtn('PODS 001-119', 'STABLE', 'Vault-Tec Execs', 'Frozen', 'Occupants: Board of Directors & Senior VPs. \\nVital signs nominal. Brain wave activity: Delta Sleep. Awakening protocol ready on Overseer command.', null, 1, '119')}
                            ${RoomBtn('POD 089', 'CRITICAL', 'S. Calvin (VP)', 'Frozen', 'Executive V.P. S. Calvin. \\n\\nWARNING: Neural decay detected. Subject appears to be experiencing "Freezer Burn" nightmares. Thaw recommended immediately.', 'NEURAL DECAY DETECTED', 1, '1')}
                            <!-- ZAX REMOVED AS REQUESTED -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Global Footer -->
            <div class="p-2 bg-black border-t border-green-900 flex justify-between items-center text-[10px] text-green-800">
                <div class="flex gap-4">
                    <span>O2 LEVELS: 98%</span>
                    <span>TEMP: 22°C</span>
                    <span>PRESSURE: 101kPa</span>
                </div>
                <div class="animate-marquee whitespace-nowrap overflow-hidden w-1/3 text-right text-green-900">
                    *** ALERT: SEISMIC TREMORS DETECTED IN SECTOR 4 *** REPORT ALL ANOMALIES TO SECURITY ***
                </div>
            </div>
        </div>`;
    }

    // --- STATUS APP (ENHANCED) ---
    function renderStatusApp() {
        const { selectedSensor } = window.state.status;

        // Detail View
        if (selectedSensor) {
            return renderEnhancedSensorDetail(selectedSensor);
        }

        // Dashboard View
        return `
        <div class="flex-1 overflow-y-auto p-4 md:p-6 grid grid-cols-1 md:grid-cols-2 gap-4 custom-scrollbar">
            
            <!-- Vital Stats -->
            <div class="border border-green-600 bg-green-900/10 p-4">
                <h3 class="text-green-400 font-bold mb-4 flex items-center gap-2"><i data-lucide="users" width="16"></i> POPULATION</h3>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div class="bg-black/40 p-2 rounded">
                        <div class="text-2xl font-bold text-green-500">880</div>
                        <div class="text-[10px] text-green-700">ACTIVE</div>
                    </div>
                    <div class="bg-black/40 p-2 rounded border border-blue-900/50">
                        <div class="text-2xl font-bold text-blue-400">120</div>
                        <div class="text-[10px] text-blue-700">FROZEN</div>
                    </div>
                    <div class="bg-black/40 p-2 rounded border border-red-900/30">
                        <div class="text-2xl font-bold text-red-500">6</div>
                        <div class="text-[10px] text-red-700">SICK</div>
                    </div>
                </div>
                <div class="mt-4 text-[10px] text-green-600 font-mono">
                    GENETIC DIVERSITY: <span class="text-yellow-500">CONCERNING</span>
                </div>
            </div>

            <!-- Reactor -->
            <div class="border border-green-600 bg-green-900/10 p-4">
                <h3 class="text-green-400 font-bold mb-4 flex items-center gap-2"><i data-lucide="zap" width="16"></i> REACTOR</h3>
                <div class="h-4 w-full bg-black mb-2 border border-green-800 overflow-hidden">
                    <div class="h-full bg-green-500 w-[98%] animate-pulse-slow"></div>
                </div>
                <div class="flex justify-between text-xs text-green-500 mb-2">
                    <span>OUTPUT: 98.4%</span>
                    <span class="text-yellow-500 animate-glitch">VIBRATION DETECTED</span>
                </div>
                <div class="text-[10px] text-green-700 leading-tight">
                    Coolant Pump B showing signs of stress. Spare parts unavailable.
                </div>
            </div>

            <!-- External Sensors -->
            <div class="col-span-1 md:col-span-2 border border-red-900/50 bg-red-900/5 p-4 relative overflow-hidden">
                <div class="absolute top-0 right-0 bg-red-900/20 px-2 py-1 text-[10px] text-red-500 font-bold animate-pulse">ZONE RED</div>
                <h3 class="text-red-400 font-bold mb-4 flex items-center gap-2"><i data-lucide="radar" width="16"></i> SURFACE SENSORS</h3>
                
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="window.setState({ status: { selectedSensor: 'SEISMIC' } })" class="p-3 border border-red-900/30 hover:bg-red-900/20 hover:border-red-500 transition-all text-center relative overflow-hidden">
                        <div class="text-red-500 font-bold text-sm mb-1 z-10 relative">SEISMIC</div>
                        <div class="h-1 w-full bg-red-900/30 overflow-hidden"><div class="h-full bg-red-500 w-3/4 animate-pulse"></div></div>
                        <div class="text-[9px] text-red-400 mt-1 animate-glitch">HEAVY MOVEMENT</div>
                    </button>
                    <button onclick="window.setState({ status: { selectedSensor: 'RADIATION' } })" class="p-3 border border-red-900/30 hover:bg-red-900/20 hover:border-red-500 transition-all text-center">
                        <div class="text-red-500 font-bold text-sm mb-1">RADS</div>
                        <div class="h-1 w-full bg-red-900/30 overflow-hidden"><div class="h-full bg-red-500 w-full animate-pulse-slow"></div></div>
                        <div class="text-[9px] text-red-400 mt-1 animate-pulse">LETHAL SPIKES</div>
                    </button>
                    <button onclick="window.setState({ status: { selectedSensor: 'AUDIO' } })" class="p-3 border border-red-900/30 hover:bg-red-900/20 hover:border-red-500 transition-all text-center">
                        <div class="text-green-500 font-bold text-sm mb-1">AUDIO</div>
                        <div class="h-1 w-full bg-green-900/30 overflow-hidden"><div class="h-full bg-green-500 w-1/2 animate-pulse"></div></div>
                        <div class="text-[9px] text-green-400 mt-1">"GHOST SIGNAL"</div>
                    </button>
                </div>
            </div>

            <!-- Resources (Improved) -->
             <div class="col-span-1 md:col-span-2 border border-green-800 bg-green-900/5 p-4">
                 <div class="flex justify-between items-center mb-2 border-b border-green-800 pb-2">
                     <h3 class="text-green-500 font-bold text-xs uppercase">Supply Manifest</h3>
                     <span class="text-[10px] text-green-700">LAST AUDIT: TODAY</span>
                 </div>
                 
                 <div class="grid grid-cols-2 gap-4">
                     <!-- Ammo Column -->
                     <div>
                        <div class="text-[10px] text-green-600 mb-1 font-bold">AMMUNITION STORES</div>
                        <div class="space-y-1">
                            <div class="flex justify-between text-xs bg-green-900/20 p-1">
                                <span>10mm Rounds</span> <span class="text-green-400">75,240</span>
                            </div>
                            <div class="flex justify-between text-xs bg-green-900/20 p-1">
                                <span>5.56mm Rounds</span> <span class="text-yellow-500 font-bold animate-pulse">3,420 (LOW)</span>
                            </div>
                            <div class="flex justify-between text-xs bg-green-900/20 p-1">
                                <span>Fusion Cores</span> <span class="text-red-500 font-bold">18 (CRITICAL)</span>
                            </div>
                        </div>
                     </div>
                     
                     <!-- Food Column -->
                     <div>
                        <div class="text-[10px] text-green-600 mb-1 font-bold">ORGANIC SUSTENANCE</div>
                        <div class="space-y-1">
                            <div class="flex justify-between text-xs bg-green-900/20 p-1">
                                <span>Hydroponic Yield</span> <span class="text-green-400">92% Eff.</span>
                            </div>
                            <div class="flex justify-between text-xs bg-green-900/20 p-1">
                                <span>Water Chip</span> <span class="text-green-400">Stable</span>
                            </div>
                            <div class="flex justify-between text-xs bg-green-900/20 p-1">
                                <span>Ration Packs</span> <span class="text-yellow-500">4,200 Units</span>
                            </div>
                        </div>
                     </div>
                 </div>
             </div>
        </div>`;
    }

    function renderEnhancedSensorDetail(type) {
        let title = '';
        let graph = '';
        let stats = '';
        let colorTheme = 'green'; // default
        
        // Fake Hex Data Generator
        const hexLog = [...Array(10)].map(() => 
            `0x${Math.floor(Math.random()*16777215).toString(16).toUpperCase().padStart(6, '0')} :: ${Math.random() > 0.5 ? 'READ' : 'WAIT'}`
        ).join('<br>');

        if (type === 'SEISMIC') {
            title = 'SEISMIC ACTIVITY MONITOR';
            colorTheme = 'red';
            // Generating a fake moving seismograph using CSS animations on bars
            const bars = [...Array(30)].map((_, i) => {
                const delay = Math.random() * 2;
                const duration = 0.5 + Math.random();
                return `<div class="w-2 bg-red-500/80 mx-[1px]" style="animation: bar-dance ${duration}s infinite ease-in-out -${delay}s;"></div>`;
            }).join('');
            
            graph = `
            <div class="h-64 flex gap-2">
                <div class="flex-1 border border-red-900 bg-black/80 relative flex items-end justify-center p-2 overflow-hidden grid-bg">
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-30">
                        <div class="w-32 h-32 rounded-full border border-red-500" style="animation: radar-spin 4s linear infinite"></div>
                        <div class="w-48 h-48 rounded-full border border-red-900 absolute"></div>
                    </div>
                    <div class="absolute top-2 left-2 text-[10px] text-red-500 font-mono animate-glitch">VIBRATION DETECTED: SECTOR 4</div>
                    <div class="flex items-end h-full w-full justify-between z-10">
                        ${bars}
                    </div>
                </div>
                <div class="w-24 border border-red-900 bg-black text-[8px] text-red-700 font-mono p-1 overflow-hidden leading-tight hidden md:block">
                    <div class="opacity-50">RAW_DATA_STREAM</div>
                    <div class="mt-2" style="animation: quick-flicker 2s infinite">${hexLog}</div>
                </div>
            </div>`;
            
            stats = `
            <div class="grid grid-cols-2 gap-4 text-xs font-mono text-red-400">
                <div class="border border-red-900/50 p-2">MAGNITUDE: <span class="text-red-500 font-bold text-lg animate-pulse">4.2</span></div>
                <div class="border border-red-900/50 p-2">EPICENTER: <span class="text-red-500">2km NORTH</span></div>
                <div class="border border-red-900/50 p-2">PATTERN: <span class="text-yellow-500 animate-glitch">RHYTHMIC (MARCHING)</span></div>
                <div class="border border-red-900/50 p-2">EST. MASS: <span class="text-red-500">>2000kg</span></div>
            </div>`;
        } 
        else if (type === 'AUDIO') {
            title = 'AUDIO SPECTRUM ANALYZER';
            colorTheme = 'green';
            const bars = [...Array(20)].map((_, i) => {
                 const height = Math.random() * 100;
                 return `<div class="w-full bg-green-500/50 border-t-2 border-green-300" style="height: ${height}%; animation: bar-dance ${0.2 + Math.random()*0.5}s infinite alternate;"></div>`;
            }).join('');

            graph = `
            <div class="h-64 flex gap-2">
                <div class="flex-1 border border-green-900 bg-black/80 relative p-4 grid-bg">
                    <div class="absolute top-2 right-2 text-[10px] text-green-500 animate-pulse">LIVE FEED</div>
                    <div class="flex items-end h-full gap-1">
                        ${bars}
                    </div>
                </div>
                <div class="w-24 border border-green-900 bg-black text-[8px] text-green-700 font-mono p-1 overflow-hidden leading-tight hidden md:block">
                    <div class="opacity-50">DECRYPTION_LOG</div>
                    <div class="mt-2">${hexLog}</div>
                </div>
            </div>`;
            
            stats = `
            <div class="grid grid-cols-2 gap-4 text-xs font-mono text-green-400">
                <div class="border border-green-900/50 p-2">SIGNAL: <span class="text-green-300 font-bold animate-glitch">ENCLAVE_RADIO_LOOP</span></div>
                <div class="border border-green-900/50 p-2">CONFIDENCE: <span class="text-green-300">98%</span></div>
                <div class="border border-green-900/50 p-2">ORIGIN: <span class="text-yellow-500">UNKNOWN</span></div>
                <div class="border border-green-900/50 p-2">STATUS: <span class="text-red-500 animate-blink">DECRYPTING...</span></div>
            </div>`;
        }
        else if (type === 'RADIATION') {
            title = 'GEIGER COUNTER HISTORY';
            colorTheme = 'yellow';
             const bars = [...Array(40)].map((_, i) => {
                 let h = 10 + Math.random() * 20;
                 if (i > 30) h += 50; // Spike at end
                 let color = h > 50 ? 'bg-red-500' : 'bg-yellow-500';
                 return `<div class="flex-1 ${color} mx-[1px]" style="height: ${h}%;"></div>`;
            }).join('');

            graph = `
             <div class="h-64 flex gap-2">
                <div class="flex-1 border border-yellow-900 bg-black/80 relative p-2 flex items-end grid-bg">
                    <div class="absolute inset-0 bg-yellow-500/5 animate-pulse"></div>
                    <div class="absolute top-2 left-2 text-[10px] text-red-500 font-bold animate-blink">DANGER: HIGH LEVELS</div>
                    ${bars}
                </div>
                <div class="w-24 border border-yellow-900 bg-black text-[8px] text-yellow-700 font-mono p-1 overflow-hidden leading-tight hidden md:block">
                    <div class="opacity-50">RAD_DOSIMETER</div>
                    <div class="mt-2">${hexLog}</div>
                </div>
            </div>`;
            
            stats = `
            <div class="grid grid-cols-2 gap-4 text-xs font-mono text-yellow-500">
                <div class="border border-yellow-900/50 p-2">CURRENT: <span class="text-red-500 font-bold text-lg animate-glitch">450 RADS</span></div>
                <div class="border border-yellow-900/50 p-2">TREND: <span class="text-red-500">RISING RAPIDLY</span></div>
                <div class="border border-yellow-900/50 p-2">SAFE LIMIT: <span class="text-green-400">50 RADS</span></div>
                <div class="border border-yellow-900/50 p-2">WIND: <span class="text-yellow-200">SW 15mph (FROM CRATER)</span></div>
            </div>`;
        }

        return `
        <div class="flex flex-col h-full p-4 animate-fade-in">
            <button onclick="window.setState({ status: { selectedSensor: null } })" class="mb-4 flex items-center gap-2 text-${colorTheme}-500 hover:text-white w-fit text-sm">
                <i data-lucide="arrow-left" width="16"></i> RETURN TO SENSORS
            </button>
            
            <div class="border-2 border-${colorTheme}-700 p-4 flex-1 flex flex-col bg-black/80 relative overflow-hidden shadow-[0_0_20px_rgba(0,0,0,0.8)]">
                <div class="flex justify-between items-center mb-4 border-b border-${colorTheme}-800 pb-2">
                    <h2 class="text-${colorTheme}-400 font-bold text-lg">${title}</h2>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-${colorTheme}-500 animate-blink"></div>
                        <span class="text-[10px] text-${colorTheme}-500">ONLINE</span>
                    </div>
                </div>
                
                ${graph}
                
                <div class="mt-4 border-t border-${colorTheme}-800 pt-4">
                    ${stats}
                </div>
                 <div class="mt-auto pt-4 text-[10px] text-${colorTheme}-700 font-mono flex justify-between">
                    <span>SENSOR ID: SENS-${type}-001</span>
                    <span class="animate-glitch">NO CONNECTION TO NETWORK</span>
                </div>
            </div>
        </div>`;
    }

    // --- INIT ---
    window.addEventListener('DOMContentLoaded', () => {
        renderApp();
    });

</script>
</body>
</html>
